import streamlit as st
import yfinance as yf
import pandas as pd
from textblob import TextBlob
from datetime import datetime

# --- SAYFA AYARLARI ---
st.set_page_config(
    page_title="Patronun Terminali",
    page_icon="ðŸ¦…",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- STÄ°L VE CSS ---
st.markdown("""
<style>
    .metric-card {
        background-color: #0e1117;
        border: 1px solid #303030;
        padding: 20px;
        border-radius: 10px;
        color: white;
    }
    .bullish { border-left: 5px solid #00ff00; }
    .bearish { border-left: 5px solid #ff0000; }
    .neutral { border-left: 5px solid #gray; }
</style>
""", unsafe_allow_html=True)

# --- PÄ°RAMÄ°T MODELÄ° KAYNAK LÄ°STESÄ° ---
LEVEL_1_SOURCES = ['Bloomberg', 'Reuters', 'SEC', 'KAP', 'Investor Relations', 'Business Wire']
LEVEL_2_SOURCES = ['WSJ', 'Financial Times', 'CNBC', 'Barron\'s']
LEVEL_3_SOURCES = ['MarketWatch', 'Investing.com', 'Seeking Alpha', 'Yahoo Finance', 'Motley Fool']

# --- FONKSÄ°YONLAR ---

def get_sentiment(text):
    """Basit Duygu Analizi (Ä°leride burayÄ± GPT ile deÄŸiÅŸtireceÄŸiz)"""
    blob = TextBlob(text)
    score = blob.sentiment.polarity
    if score > 0.1: return "YUKARI (Bullish)", "ðŸŸ¢", score
    elif score < -0.1: return "AÅžAÄžI (Bearish)", "ðŸ”´", score
    else: return "NÃ–TR", "âšª", score

def determine_source_level(publisher):
    """Haber kaynaÄŸÄ±nÄ± Piramit Modeline gÃ¶re derecelendirir"""
    publisher = str(publisher).lower()
    if any(src.lower() in publisher for src in LEVEL_1_SOURCES): return 1
    if any(src.lower() in publisher for src in LEVEL_2_SOURCES): return 2
    return 3

def fetch_data(ticker):
    stock = yf.Ticker(ticker)
    try:
        # Fiyat Verisi
        hist = stock.history(period="1d")
        if hist.empty: return None, None, None
        price = hist['Close'].iloc[-1]
        
        # Åžirket Bilgisi
        info = stock.info
        
        # Haberler
        news = stock.news
        processed_news = []
        for item in news:
            sentiment, icon, score = get_sentiment(item.get('title', ''))
            level = determine_source_level(item.get('publisher', ''))
            
            processed_news.append({
                'Tarih': datetime.fromtimestamp(item.get('providerPublishTime', 0)),
                'BaÅŸlÄ±k': item.get('title'),
                'Kaynak': item.get('publisher'),
                'Seviye': level,
                'YÃ¶n': sentiment,
                'Link': item.get('link'),
                'Skor': score
            })
            
        df_news = pd.DataFrame(processed_news)
        if not df_news.empty:
            df_news = df_news.sort_values(by=['Seviye', 'Tarih'], ascending=[True, False])
            
        return price, info, df_news
    except Exception as e:
        st.error(f"Hata oluÅŸtu: {e}")
        return None, None, None

# --- ARAYÃœZ ---
st.title("ðŸ¦… Patronun Piyasa RadarÄ± v0.1")
st.markdown("*AkÄ±lcÄ± ÅžÃ¼phe, Tam DoÄŸrulama*")
st.divider()

# Sidebar
with st.sidebar:
    st.header("Kontrol Paneli")
    ticker = st.text_input("Hisse Kodu (Ã–rn: AAPL, THYAO.IS)", value="AAPL").upper()
    st.info("Level 1 kaynaklar Ã¶nceliklendirilmiÅŸtir.")

# Ana Ekran
if ticker:
    price, info, news_df = fetch_data(ticker)
    
    if price:
        # Ãœst Bilgi KartlarÄ±
        c1, c2, c3, c4 = st.columns(4)
        c1.metric("Fiyat", f"{price:.2f}")
        c2.metric("SektÃ¶r", info.get('sector', '-'))
        c3.metric("F/K OranÄ±", info.get('trailingPE', '-'))
        c4.metric("Hedef Fiyat", info.get('targetMeanPrice', '-'))
        
        st.divider()
        
        # Analiz BÃ¶lÃ¼mÃ¼
        col_news, col_chart = st.columns([1, 1])
        
        with col_news:
            st.subheader("ðŸ“¡ Haber Analiz AkÄ±ÅŸÄ±")
            if news_df is not None and not news_df.empty:
                for _, row in news_df.iterrows():
                    # Stil belirleme
                    css_class = "bullish" if "YUKARI" in row['YÃ¶n'] else "bearish" if "AÅžAÄžI" in row['YÃ¶n'] else "neutral"
                    
                    st.markdown(f"""
                    <div class="metric-card {css_class}" style="margin-bottom:10px;">
                        <small>{row['Tarih'].strftime('%H:%M')} | <strong>{row['Kaynak']} (L{row['Seviye']})</strong></small>
                        <h5><a href="{row['Link']}" style="color:white;text-decoration:none;">{row['BaÅŸlÄ±k']}</a></h5>
                        <p>{row['YÃ¶n']}</p>
                    </div>
                    """, unsafe_allow_html=True)
            else:
                st.warning("Haber akÄ±ÅŸÄ± yok.")
                
        with col_chart:
            st.subheader("ðŸ“ˆ Fiyat GrafiÄŸi (Price Action)")
            st.line_chart(yf.Ticker(ticker).history(period="1y")['Close'])
            st.caption("YakÄ±nda buraya ICT konseptleri ve FVG kutularÄ± eklenecek.")
            
    else:
        st.error("Veri alÄ±namadÄ±.")